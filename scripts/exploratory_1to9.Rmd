---
title: "Univariate plots of Yaounde COVID study data"


### Options for outputting HTML
# 
# output:
#   rmarkdown::html_document:
#     theme: cerulean
#     toc: true
#     toc_depth: 2
#     toc_float: true
# 


# Options for outputting PDF
output:
  bookdown::pdf_document2:
    toc: true
    number_sections: false
    latex_engine: xelatex
    includes:
      in_header: preamble.tex
mainfont: Avenir
fontsize: 10pt
geometry: left=2cm,right=2cm,top=2.5cm,bottom=2cm
# 
# ## Options for outputting Word
# output: word_document
# fontsize: 10pt
# geometry: left=2cm,right=2cm,top=2.5cm,bottom=2cm

## Other options
editor_options: 
  chunk_output_type: console
params: 
  mode: "pdf"
---

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F, dpi = 300,
                      fig.width = 6, 
                      fig.height = 1.75,
                      fig.align = "center" )

# force figures not to float
knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")


# params$mode <- "pdf"

library(pacman)

p_load(
       "readxl",
       "here",
       "janitor",
       "stringi",
       "usethis",
       "renv",
       "plotly",
       "vegan",
       "reshape2",
       "viridis",
       "GGally",
       "heatmaply",
       "superheat",
       "styler",
       "paletteer",
       "scales",
       "ggtext",
       "inspectdf",
       "purrr",
       "scales",
       "lubridate",
       "highcharter",
       "leaflet",
       "ExPanDaR",
       "ggupset",
       "gridExtra",
       "UpSetR", ##devtools::install_github("NightingaleHealth/ggforestplot")
       "magrittr",
       "devtools",
       "ggforestplot",
       "gt", 
       "kableExtra",
       "huxtable",
       "tidyverse", 
       "patchwork"
       )


# usethis::use_github(protocol = "https", auth_token = Sys.getenv("GITHUB_PAT"))

# 
# # palette
# my_palette <- c("#56bfa3", "#f79f57" ,"#7570B3","#56B4E9",  #greenblue #lightorange #purplepastel  #lightblue
#                 "#3758a6" , "#CC79A7" , "#91142c", "#eb4034", #darkblue #pinkpurple #wine #orange
#                 "#a3b0c4", "#870476", "#479444", "#3cd6d6" ) # grey, # royalpurple #darkgreen # cyan
# 
my_palette <- paletteer_d("awtools::bpalette") %>% as.character() %>% str_sub(end = 7)

scale_colour_discrete <- function(...) {
  scale_colour_manual(..., values = my_palette)
}

scale_fill_discrete <- function(...) {
  scale_fill_manual(..., values = my_palette)
}


# theme
my_theme <- theme_classic() +
  theme(text = element_text( size = 12.5),
        rect = element_blank(), # transparent background
        plot.title = (element_text(face = "bold", hjust = 0.5, size = 13)),
        plot.subtitle = (element_text( hjust = 0.5, size = 8, color = alpha("black", 0.7))),
        plot.caption = element_text(size = 6.5, color = "gray50", hjust = 1),
        legend.position = "bottom",
        legend.text = element_text(size = 8),
        legend.key.size = unit(1,"line"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9 ),
        axis.line = element_line(color = "gray40", size = 0.5),
        axis.line.y = element_blank(),
        panel.grid.major = element_line(color = alpha("gray50", 0.1), size = 0.25), 
        strip.background = element_blank(),
        strip.text = element_text(face = "bold", color = 'white'),
        panel.spacing.x = unit(3, "mm"), 
        title = element_text(face = "bold"), 
        panel.border = element_blank(),
        plot.background = element_rect(fill = "#f5f5f5"), 
        panel.background = element_rect(fill = "white")
        #strip.background = element_blank()
        )

theme_set(my_theme)

options(scipen=999) # turn off scientific notation

options(tibble.print_max = 30, tibble.print_min = 30)
# 
# category_names <- 
#   read_excel(here("data/EPICO19_-_all_versions_26 11 approved.xlsx"), sheet = 3) %>% 
#   select(raw_name) %>% 
#   separate(raw_name, into = c("var", "category"), sep = "/") %>% 
#   select(category) 
# 
# write_excel_csv(category_names, file = here("data/category_names.csv"), na = "")
#   
# 

```

```{r utilityFunctions}
source(here("scripts/utils.R"))

```

```{r readData}
yao_raw <- 
  read_excel(here("data/EPICO19_-_all_versions_26 11 approved.xlsx"), sheet = 1) %>% 
  type_convert()


## read in clean names and replace
data_dict <- read_excel(here("data/EPICO19_-_all_versions_26 11 approved.xlsx"), sheet = 3)

raw_name <- data_dict$raw_name
clean_name <- data_dict$clean_name
axis_name <- data_dict$axis_name 

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~  We sort the replacements in descending order of length ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# this should reduce problems 
raw_category <- 
  data_dict %>% 
  select(raw_category) %>% 
  mutate(raw_category = ifelse(is.na(raw_category), "PLACEHOLDER_TEXT_PLACEHOLDER_TEXT",  raw_category)) 

clean_category <- 
  data_dict %>% 
  select(clean_category) %>% 
  mutate(clean_category = ifelse(is.na(clean_category), "PLACEHOLDER_TEXT_PLACEHOLDER_TEXT",  clean_category)) 

# place together and arrange so order is preserved
category_dictionary_tib <- 
  tibble(raw_category, clean_category) %>% 
  mutate(length = str_length(raw_category)) %>% 
  arrange(-length)

raw_category <-  category_dictionary_tib$raw_category 
clean_category <-  category_dictionary_tib$clean_category 

category_dictionary <- setNames(object = clean_category, nm = raw_category)


yao <-
  yao_raw %>%
  ## add counter column. 1 for all real records. Useful for counting later (where we use 0 for fake records)
  mutate(counter = 1) %>% 
  ## rename to new names
  rename_with(.cols = any_of(raw_name), .fn = ~ clean_name[which(raw_name == .x)]) %>%
  # select(where( ~ !(all(is.na(.x)) | all(.x=="")) )) %>%
  ## remove rows with double slash in id
  mutate(id_quest = str_replace(id_quest, "//", "/")) %>%
  ## remove accents
  mutate(id_quest = stri_trans_general(id_quest, "Latin-ASCII")) %>%
  ## separate questionnaire id then recombine to form unique household id and individual id
  separate(id_quest, into = c("loc_hhld", "id_hhld_letter", "id_hhld_num", "id_ind_num"), sep = "/", remove = F) %>%
  mutate(loc_hhld = str_replace_all(loc_hhld, "NKOMNKANA", "NKOMKANA")) %>%
  mutate(id_hhld = paste(loc_hhld, id_hhld_num, sep = "_")) %>%
  mutate(id_ind = paste(loc_hhld, id_hhld_num, id_ind_num, sep = "_")) %>%
  relocate(id_hhld, id_ind, .before = everything()) %>%
  ## arrange by these ids
  arrange(loc_hhld, id_hhld_num, id_ind_num) %>%
  filter(id_quest != "MOKOLO/KAR/013/0003") %>%
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  #~  Clean multi-answer columns ----
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    mutate(across( .cols = matches("mcat"), 
                 .fns = ~ str_replace_all(.x, " ", "--") 
                 )) %>% 
    mutate(across( .cols = matches("mcat"), 
                 .fns = ~ str_replace_all(.x, category_dictionary)
                 )) %>% 
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  #~  Clean single-answer columns ----
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # education level
  mutate(cat_educ = case_when(cat_educ == "ecole_secondaire" ~ "Secondary", 
                              cat_educ == "ecole_primaire" ~ "Primary", 
                              cat_educ == "universit" ~ "University", 
                              cat_educ == "aucune_instruction_officielle" ~ "No formal instruction", 
                              cat_educ == "doctorat" ~ "Doctorate", 
                              cat_educ == "autre" ~ "Other", 
                              TRUE ~ cat_educ)) %>% 
  mutate(cat_symp_severity = case_when(cat_symp_severity == "sympt_mes_mod_r_s" ~ "Moderate", 
                                       cat_symp_severity == "sympt_mes_s_v_res" ~ "Severe", 
                                       TRUE ~ cat_symp_severity)) %>% 
  mutate(has_mem_lost_job = case_when(has_mem_lost_job == "perte_totale_du_travail_revenus" ~ "Complete loss of work income", 
                                      has_mem_lost_job == "pas_de_perte_de_travail_revenus" ~ "No loss of work income", 
                                      has_mem_lost_job == "diminution_du_temps_de_travail_revenus" ~ "Reduction in work income", 
                                      TRUE ~ has_mem_lost_job)) %>%
  mutate(has_partic_COVID_study = recode(has_partic_COVID_study, 
                                         "ne_sais_pas" = "Don't Know")) %>% 
  mutate(has_tested = recode(has_tested, 
                             "ne_r_ponds_pas__inappropri__ne_sait_pas_" = "No response"
                             )) %>% 
  mutate(is_smoker = recode(is_smoker, 
                            "No_fumeur__je_n_ai_jamais_fum" = "Non-smoker (I've never smoked)", 
                            "fumeur__je_fume_actuellement" = "Smoker (I currently smoke)", 
                            "ex_fumeur__j_ai_fum__mais_ne_fume_plus" = "Ex-smoker (I used to smoke but stopped)"
                            ), 
         is_smoker = if_else(str_detect(is_smoker, "jamais"), 
                             "Non-smoker (I've never smoked)", 
                             is_smoker) ) %>% 
  mutate(has_contact_COVID = recode(has_contact_COVID, 
                                    "je_ne_sais_pas" = "I don't know"
                                    )) %>% 
  mutate(has_contact_traveller = recode(has_contact_traveller, 
                                    "je_ne_sais_pas" = "I don't know"
                                    )) %>% 
  mutate(rate_virus_serious = recode(rate_virus_serious, 
                                     "plus_haut_que_les_autres_personnes" = "More than other people's", 
                                     "moins_que_les_autres_personnes" = "Less than other people's", 
                                     "comme_les_autres_personnes" = "The same as other people's"
                                     )) %>% 
   #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  #~  Clean across multiple columns ----
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ## replace ne repond pas variants with No response
  mutate(across(.cols = function(.x) is.character(.x) | is.factor(.x) , .fns = function(.x) str_replace_all(.x, "ne_r_pond_pas__inappropri__ne_sait_pas__", "No response"))) %>%
  mutate(across(.cols = function(.x) is.character(.x) | is.factor(.x) , .fns = function(.x) str_replace_all(.x, "ne_r_pond_pas__inappropri__ne_sait_pas_", "No response"))) %>%
  mutate(across(.cols = function(.x) is.character(.x) | is.factor(.x) , .fns = function(.x) str_replace_all(.x, "ne_peut_pas_r_pondre__inappropri__ne_sai", "No response"))) %>%
  mutate(across(.cols = function(.x) is.character(.x) | is.factor(.x) , .fns = function(.x) str_replace_all(.x, "ne_r_pond_pas__inappropri__ne_", "No response"))) %>%
  mutate(across(.cols = function(.x) is.character(.x) | is.factor(.x) , .fns = function(.x) str_replace_all(.x, "non", "No"))) %>%
  mutate(across(.cols = function(.x) is.character(.x) | is.factor(.x) , .fns = function(.x) str_replace_all(.x, "oui", "Yes")))

## Subset and count households with at least one head
yao_hhld_heads <- 
  yao %>%
  # keep only household heads
  filter(is_head == "Yes") %>%
  # pick the first household head if multiple
  group_by(id_hhld) %>%
  arrange(id_ind) %>%
  slice_head(n = 1) %>%
  # ungroup
  ungroup()

yao_hhld_first_adults <- 
  yao %>% 
  # add counter for excluding non-headed households
  mutate(is_head_counter = if_else(is_head == "Yes", 1, 0)) %>%
  group_by(id_hhld) %>%
  # keep households without a head
  filter(sum(is_head_counter) == 0) %>%
  # keep adults
  filter(val_age >= 18) %>%
  # take the first adult 
  arrange(id_ind_num) %>% 
  slice_head(n = 1) %>%
  # ungroup
  ungroup()


yao_hhld  <- 
  yao_hhld_heads %>% 
  bind_rows(yao_hhld_first_adults)

# 
# #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# #~  Household count ----
# #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 
# ## Subset and count households with at least one head
# yao %>% 
#   group_by(id_hhld) %>% 
#   filter(is_head == "Yes") %>% 
#   arrange(id_hhld, id_ind) %>% 
#   # pick the first household head if multiple
#   slice_head(n = 1) %>% 
#   ungroup() %>% 
#   dim()
# ## there are 171 of them
# 
# 
# ## subset and count household with no head
# yao %>% 
#   mutate(is_head_counter = if_else(is_head == "Yes", 1, 0)) %>% 
#   group_by(id_hhld) %>% 
#   # keep households without a head
#   filter(sum(is_head_counter) == 0) %>% 
#   slice_head(n = 1) %>% 
#   ungroup() %>% 
#   dim()
# ## there are 49 of them
# 
# 
# 
# 
# ## do all households without heads have at least one adult?
# yao %>% 
#   mutate(is_head_counter = if_else(is_head == "Yes", 1, 0)) %>% 
#   group_by(id_hhld) %>% 
#   # keep households without a head
#   filter(sum(is_head_counter) == 0) %>% 
#   filter(val_age >= 18) %>% 
#   slice_head(n = 1) %>% 
#   ungroup() %>% 
#   dim()
# ## no. Only 45 no-head households have an adult in them
# 
# 
# ## lets look at the households which do not have an adult within them
# yao %>% 
#   mutate(is_head_counter = if_else(is_head == "Yes", 1, 0)) %>% 
#   mutate(is_adult_counter = if_else(val_age >= 18 , 1, 0)) %>% 
#   group_by(id_hhld) %>% 
#   ## keep households without a head
#   filter(sum(is_head_counter) == 0) %>% 
#   ## keep households without an adult
#   filter(sum(is_adult_counter) == 0) %>% 
#   ungroup() %>% 
#   select(id_hhld, id_ind, val_age)
# ## they look to mostly consist of recoding errors

# 
# yao %>% 
#   select(where( ~ length(unique(.x)) < 10)) %>% 
#   select(where( ~ length(unique(.x)) > 1)) %>% 
#   select( !matches("mcat")  ) %>% 
#   select( !matches("unknown")  ) %>% 
#   select( !starts_with("is_")  ) %>% 
#   select( !starts_with("has")  ) %>% 
#   select(!matches("0") & !matches("1") & !matches("2") & !matches("3") & !matches("4")&  !matches("5")  ) %>% 
#   select(!matches("other")) %>% 
#   inspect_cat() %>%
#   show_plot(col_palette = 1) 
# 
# yao %>% 
#   select(where( ~ length(unique(.x)) > 1)) %>% 
#   # select( !matches("mcat")  ) %>% 
#   select( !matches("unknown")  ) %>% 
#   select( !starts_with("has")  ) %>% 
#   select( !starts_with("is_")  ) %>% 
#   select(!matches("0") & !matches("1") & !matches("2") & !matches("3") & !matches("4")&  !matches("5")  ) %>% 
#   select(!matches("other")) %>% 
#   inspect_num() %>%
#   show_plot(col_palette = 1)  + 
#   theme(strip.background = element_rect(fill = "black"))

# 
# 
# mutate(across(.cols = where(~ length(unique(.x)) < 10),
#                 .fns =  ~ as.factor(.x))) %>%
#   # distribution of factor variables
#   inspect_num() %>%
#   show_plot(col_palette = 1) + 
#   labs(subtitle = "Numeric vars. with 9 or fewer unique values were converted to factors")

```

# 1 Administration of questionnaire

## 1.1 Is this the original sampled household?

(per household)
```{r}
yao_hhld %>% 
  mutate(is_hhld_samp = str_replace_all(is_hhld_samp, c("0" = "Original", 
                                                        "1" = "Replacement"
                                                        ))) %>%
  mutate(is_hhld_samp = as.factor(is_hhld_samp)) %>% 
  countplotprint(is_hhld_samp, flip = T)
```

**NOTE** It is not clear to me whether 0 means "original" or "replacement".

## 1.3 Which surveyors administered the questionnaire?

(per respondent)
```{r}
yao %>% 
  mutate(name_researcher = str_replace_all(name_researcher, "_", ", ")) %>% 
  mutate(name_researcher = str_to_title(name_researcher)) %>% 
  countplotprint(name_researcher, fct_reorder = T, flip = T)
```

## 1.4 Date of survey completion

(per respondent)
```{r fig.height=7}

yao %>% 
  countprop(dt_quest, date_parse = T) %>% 
  rename_for_countplot_axis() %>% 
  countplot(`Date Questionnaire Administered`, flip = T, date_parse = T, vjust_label = 0.5, hjust_label = -0.2) + 
  scale_x_date(date_breaks = "1 day", date_labels = "%b %d")

```

## 1.5 City Area

(per household)
```{r fig.height=2.4}
yao_hhld %>% 
  mutate(loc_hhld_area = str_to_title(loc_hhld_area)) %>% 
  countplotprint(loc_hhld_area,  fct_reorder = T, flip = T)
```

\newpage

# 2 Household Composition

All variables below are per household. The answers from a single representative individual are taken to represent the information about the household. 

This representative individual is either: 

* The first "household head" to be interviewed in a household; or
* In cases where there is no head, the first individual above 18 to be interviewed in the household. 

## 2.2 GPS location

```{r, fig.height=2}
for_map <- yao %>% 
  mutate(loc_hhld_lat = as.numeric(loc_hhld_lat), 
         loc_hhld_long = as.numeric(loc_hhld_long))


leaflet(options = leafletOptions(preferCanvas = TRUE) ) %>%
  addTiles() %>% 
  # Customers
  addMarkers(data = for_map, 
             lat = ~ loc_hhld_lat, 
             lng = ~ loc_hhld_long,
             clusterOptions = markerClusterOptions())  %>% 
  addCircleMarkers(data = for_map, lat = ~ loc_hhld_lat, lng = ~ loc_hhld_long, color = "black", radius = 2 ) 

```


```{r, eval=(params$mode == "pdf")}
"**NOTE**    The map above is a screenshot of an interactive web map. See the html version of this report to access map " %>% 
  data.frame() %>% 
  gt() %>% 
  fmt_markdown(columns = 1) %>%
  tab_options(column_labels.hidden = T)
```

## 2.3 Number of rooms

```{r}
yao_hhld %>% 
  mutate(n_hhld_rooms = as.factor(n_hhld_rooms)) %>% 
  countplotprint(n_hhld_rooms, fct_inseq = T, flip = F) 
```

## 2.4 Number of adults

```{r}
yao_hhld %>% 
  mutate(n_hhld_persons = as.factor(n_hhld_persons)) %>% 
  countplotprint(n_hhld_persons, fct_inseq = T, flip = F) 
```

## 2.5 Number of children 

```{r}
yao_hhld %>%  
  mutate(n_hhld_children = as.factor(n_hhld_children)) %>% 
  countplotprint(n_hhld_children, fct_inseq = T, flip = F)
```


## 2.7 Have there been deaths in the household since March 1st?

```{r}
yao_hhld %>%  
  countplotprint(has_hhld_death, na_relevel = T, flip = T)
```

**NOTE** Here, NA means the cell was completely blank. NR means it was filled in as "Ne repond pas"

## 2.7.1  If there have been deaths in the household since March 1st, specify

All deaths reported are shown in the table below. No household had more than one death.
```{r }

death_dict <- read_excel(here("data/EPICO19_-_all_versions_26 11 approved.xlsx"), sheet = 4)

from_death_dict <- death_dict$from
to_death_dict <- death_dict$to 

death_dict <- setNames(object = to_death_dict, nm = from_death_dict)


yao_hhld %>%  
  filter(!is.na(dt_dead1_death)) %>% 
  select(dt_dead1_death, cat_dead1_sex, val_dead1_age, cat_dead1_cause) %>% 
  mutate(across( .fns = ~ str_replace_all(.x, death_dict))) %>% 
  mutate(dt_dead1_death = if_else( str_length(dt_dead1_death) != 10, NA_character_, dt_dead1_death ), 
         dt_dead1_death = as.Date(dt_dead1_death)) %>% 
  arrange(desc(dt_dead1_death)) %>% 
  mutate(dt_dead1_death = format.Date(dt_dead1_death, format = "%b %d" )) %>% 
  mutate(cat_dead1_sex = recode(cat_dead1_sex, "H" = "M")) %>% 
  rename(`Date of Death` = dt_dead1_death, 
         Sex = cat_dead1_sex, 
         `Age at Death` = val_dead1_age, 
         `Cause of Death` = cat_dead1_cause) %>% 
  huxtable() %>% 
  set_all_padding(0.5) %>%
  set_na_string("Unspecified") %>% 
  theme_blue()
    

```


\newpage

# 3 Information about the household

## 3.1 Are you the "Chef du menage"?

```{r}
yao %>%
  countplotprint(is_head,  na_relevel = T, flip = T)
```


## 3.2 Are you the principal breadwinner in the household?

```{r}
yao %>%
  countplotprint(is_breadwin, na_relevel = T, flip = T)
```


## 3.3 Who is the principal breadwinner in the household?

(Only answers from household representatives are shown.)
```{r fig.height = 3}
yao_hhld %>%
  plot_upset(mcat_breadwin)
```


## 3.4 What are the revenue sources of the family?

(Only answers from household representatives are shown.)
```{r fig.height = 3}
yao_hhld %>%
  plot_upset(mcat_rev_source, intersect_cutoff = 1)
```


## 3.4.1 If you answered "Other" to the previous question, specify

(Only answers from household representatives are shown.)

```{r}

yao_hhld %>% 
  filter(!is.na(cat_rev_source_other)) %>%
  mutate(cat_rev_source_other = str_to_title(cat_rev_source_other)) %>% 
  mutate(cat_rev_source_other = stri_trans_general(cat_rev_source_other, "Latin-ASCII") ) %>% 
  count(cat_rev_source_other) %>% 
  rename(`Other income source` = cat_rev_source_other) %>% 
  arrange(-n) %>%
  huxtable() %>% 
  set_all_padding(1.5) %>% 
  theme_blue()

```



## 3.5 Since March 1st, has the revenue of the household diminished?

(Only answers from household representatives are shown.)
```{r}
yao_hhld %>%
  countplotprint(has_rev_dropped,fct_reorder = T, na_relevel = T, flip = T)
```


## 3.6 Has a household member lost their job or had their working hours reduced?

(Only answers from household representatives are shown.)
```{r}
yao_hhld %>%
  countplotprint(has_mem_lost_job,
                 fct_reorder = F,
                 na_relevel = T,
                 flip = T
                 )
```


## 3.7 Has a household member tested positive for COVID-19?

(Only answers from household representatives are shown.)
```{r}
yao_hhld %>%
    countplotprint(has_mem_tested_positive,
                   flip = T,
                   na_relevel = T)
```


## 3.7.1 If a household member has tested positive for COVID-19, specify

(Only answers from household representatives are shown.)

```{r}
yao_hhld %>%
  filter(!is.na(dt_test1_test)) %>% 
  mutate(dt_test1_test = recode(dt_test1_test, 
                                "05/08/2020" = "2020-08-05"), 
         dt_test1_test = as.Date(dt_test1_test)) %>% 
  select(dt_test1_test, val_test1_age, cat_test1_sex) %>% 
  rename( `Date of Test` = dt_test1_test, 
          Age = val_test1_age, 
          Sex = cat_test1_sex) %>% 
  huxtable() %>% 
  set_all_padding(1.5) %>%
  theme_blue()
```

\newpage

# 4. Socio-administrative information about the surveyed individual

## 4.1 Sex

```{r}
yao %>%
  mutate(cat_sex = str_replace_all(cat_sex, "femme", "Female"),
         cat_sex = str_replace_all(cat_sex, "homme", "Male")) %>%
  countplotprint(cat_sex, flip = T)

```

## 4.2 Age

```{r}
yao %>%
  mutate(val_age= as.numeric(val_age)) %>%
  mutate(val_age = cut(val_age, breaks = seq(from = 0, to = 100, by = 10))) %>%
  countplotprint(val_age, drop_unused = T)
```


## 4.3 Date of birth

```{r}
p <- 
  yao %>%
  mutate(dt_birth = lubridate::year(dt_birth))  %>%
  mutate(dt_birth = cut(dt_birth,
                        breaks = seq(from = min(.$dt_birth, na.rm = T),
                                     to = max(.$dt_birth, na.rm = T),
                                     by = 10),
                        dig.lab = 5)) %>%
  countplotprint(dt_birth) +
  theme(axis.text.x.bottom = element_text(size = 8))

print(p)
```

## 4.4 Education level

```{r}
yao %>%
  countplotprint(cat_educ, fct_reorder = T, flip = T, na_relevel = T)
```


## 4.5 "Are you currently a..." (occupation)

```{r fig.height = 4.2}

yao %>%
  # not sure what these are
  filter(mcat_occup != "") %>%
  plot_upset(mcat_occup, intersect_cutoff = 3)
```


## 4.5.1 If you answered "Other" to the previous question, specify 

```{r}
yao %>% 
  filter(!is.na(cat_occup_other)) %>%
  mutate(cat_occup_other = str_to_title(cat_occup_other)) %>% 
  mutate(cat_occup_other = stri_trans_general(cat_occup_other, "Latin-ASCII") ) %>% 
  count(cat_occup_other) %>% 
  rename(`Other occupation` = cat_occup_other) %>% 
  arrange(-n) %>%
  huxtable() %>% 
  set_all_padding(1.5) %>%
  theme_blue()
```


\newpage

# 5. Symptoms suggestive of COVID-19

## 5.1 Since the 1st of March, have you had one or several of the following symptoms?

(All respondents)
```{r fig.width = 7, fig.height = 3.5}

yao %>%
  plot_upset(mcat_symp,
             intersect_cutoff = 3,
             sep = "--",
             set_size_lab = "Set size \n(and % with this symptom)",
             intersect_size_lab = "Intersection size \n(and % with this combination)")

```

(Subset of those who have had symptoms)
```{r fig.width = 7, fig.height = 3.5}

yao %>%
  filter(mcat_symp != "No symptoms") %>%
  plot_upset(mcat_symp,
             intersect_cutoff = 3,
             sep = "--",
             set_size_lab = "Set size \n(and % with this symptom)",
             intersect_size_lab = "Intersection size \n(and % with this combination)"
             )

```


## 5.1.1 If you answered "other" to the previous question, specify

```{r}

yao %>% 
  filter(!is.na(cat_symp_other)) %>% 
  count(cat_symp_other) %>% 
  rename(`Additional Symptom` = cat_symp_other) %>% 
  huxtable() %>% 
  set_all_padding(1.5) %>%
  theme_blue()

```



## 5.1.2 How severe have your symptoms been?

(Among those with symptoms)
```{r}
yao %>%
  filter(mcat_symp != "No symptoms" & !is.na(mcat_symp) & mcat_symp != "") %>%
  countplotprint(cat_symp_severity, flip = T, na_relevel = T)
```


## 5.1.3 FOr how many days were you bedridden?

(Among those with symptoms)
```{r}

lump_below <- quantile(yao$n_bedridden_days, 0.95, na.rm = T) %>% as.numeric() %>% round()
max_val <- max(yao$n_bedridden_days, na.rm = T)
min_val <- min(yao$n_bedridden_days, na.rm = T)
min_max_range <- min_val:max_val


yao %>%
  filter(mcat_symp != "No symptoms" & !is.na(mcat_symp) & mcat_symp != "") %>%
  mutate(n_bedridden_days = factor(n_bedridden_days, levels = min_max_range)) %>%
  mutate(n_bedridden_days = as.numeric(n_bedridden_days),
         n_bedridden_days = cut(n_bedridden_days,
                              breaks = c( 0 : lump_below , max_val),
                              labels = c(as.character( 0 : (lump_below - 1)),
                                         paste0(lump_below,  " - ", max_val )
                                         ),
                              dig.lab = 5)) %>%
  countplotprint(n_bedridden_days, fct_inseq = T, drop_unused = F)

```


## 5.1.3 For how many days were you unable to go to work?

(Among those with symptoms)
```{r}


lump_below <- quantile(yao$n_days_miss_work, 0.95, na.rm = T) %>% as.numeric() %>% round()
max_val <- max(yao$n_days_miss_work, na.rm = T)
min_val <- min(yao$n_days_miss_work, na.rm = T)
min_max_range <- min_val:max_val


yao %>%
  filter(mcat_symp != "No symptoms" & !is.na(mcat_symp) & mcat_symp != "") %>%
  mutate(n_days_miss_work = factor(n_days_miss_work, levels = min_max_range)) %>%
  mutate(n_days_miss_work = as.numeric(n_days_miss_work),
         n_days_miss_work = cut(n_days_miss_work,
                              breaks = c( 0 : lump_below , max_val),
                              labels = c(as.character( 0 : (lump_below - 1)),
                                         paste0(lump_below,  " - ", max_val )
                                         ),
                              dig.lab = 5)) %>%
  countplotprint(n_days_miss_work, fct_inseq = T, drop_unused = F)

```


\newpage


# 6 Treatment course for symptoms characteristic of COVID-19

## 6.1 Since March 1st, have you sought medical care for symptoms characteristic of COVID-19?

```{r}

yao %>%
  countplotprint(has_consult_care, na_relevel = T, flip = T)

```


## 6.1.1 Who/Where did you consult for your symptoms?

(Among those who have consulted care.)
```{r fig.width= 7,  fig.height = 3.7}

yao %>%
  filter(has_consult_care == "Yes") %>%
  plot_upset(cat_col = mcat_consult,
             sep = "--")

```


## 6.1.1.1 If you answered Other to the previous question, specify

```{r}

yao %>% 
  filter(!is.na(cat_consult_other)) %>% 
  count(cat_consult_other) %>% 
  rename(`Place of consultation` = cat_consult_other) %>% 
  huxtable() %>% 
  set_all_padding(1.5) %>%
  theme_blue()

```



## 6.2 Have you taken one or several medications for symptoms characteristic of COVID-19?

(Among those who have consulted care.)
```{r fig.height = 3}
yao %>%
  filter(has_consult_care == "Yes") %>%
  plot_upset(cat_col = mcat_drug,
             intersect_cutoff = 1,
             sep = "--"
             )

```

\newpage

### 6.2.1 If you answered "Other" to the previous question, specify

(We could clean this up later)
```{r}
drug_table <- 
  yao %>%
  count(cat_drug_other) %>%
  filter(!is.na(cat_drug_other)) %>%
  uncount(n) %>% 
  separate_rows(cat_drug_other, sep = ",") %>% 
  mutate(cat_drug_other = str_replace_all(cat_drug_other, "antipa", "anti pa"), 
         cat_drug_other = str_replace_all(cat_drug_other, "-", " "), 
         cat_drug_other = str_trim(cat_drug_other),
         cat_drug_other = str_to_title(cat_drug_other)
         ) %>%
  count(cat_drug_other) %>% 
  arrange(-n) %>% 
  rename("Drug" = 1)


tab_length <- nrow(drug_table)
half_tab_length <- (nrow(drug_table)/2) %>% ceiling()

drug_table1 <- 
  drug_table[1 : half_tab_length ,      ] 
  
drug_table2 <- 
  drug_table[ (half_tab_length + 1) : tab_length, ] %>% 
  rename(`Drug ` = Drug , `n ` = n ) 

rows_to_add1 <- nrow(drug_table2) - nrow(drug_table1)
rows_to_add2 <- nrow(drug_table1) - nrow(drug_table2)


if (rows_to_add1 > 0){
  drug_table1 <- 
    drug_table1 %>% 
    add_row(Drug = rep(NA_character_, rows_to_add1), 
            n = rep(NA_integer_, rows_to_add1))
}

if (rows_to_add2 > 0){
  drug_table2 <- 
    drug_table2 %>% 
    add_row(`Drug ` = rep(NA_character_, rows_to_add2), 
            `n ` = rep(NA_integer_, rows_to_add2))
}
  
drug_table1 %>% 
  add_column(drug_table2) %>% 
  huxtable() %>% 
  set_all_padding(1.5) %>%
  theme_blue()

```



<!-- ## 6.2.2 Were the medications described above recommended by ... -->

<!-- ```{r} -->
<!-- yao %>%  -->
<!--   filter(mcat_drugsource != "") %>%  -->
<!--   plot_upset(mcat_drugsource) -->

<!-- ``` -->

## 6.4 Have you been hospitalized since March 1st?

```{r fig.height = 3, fig.width= 7}

yao %>%
  plot_upset(mcat_hospitalised)

```


<!-- ## 6.4.1 Location of hospitalization  -->

<!-- ```{r} -->

<!-- ``` -->

## 6.5 If you have taken steps to access care regarding suspected or confirmed COVID-19, did you pay?

```{r fig.height = 3, fig.width= 7}

yao %>%
  filter(mcat_cost != "") %>%
  plot_upset(mcat_cost)

```


## 6.6 Have you participated in a prior COVID 19 Study?

```{r}
yao %>%
  countplotprint(has_partic_COVID_study, flip = T)

```


\newpage

# 7 Sequelae following COVID-19-like symptoms

## 7.1 Have you had health problems which have persisted after having COVID-like symptoms?

(Subsetted to those who showed COVID-like symptoms)

```{r}
yao %>%
  filter(mcat_symp != "No symptoms" & !is.na(mcat_symp) & mcat_symp != "") %>%
  countplotprint(has_sequela, flip = T, na_relevel = T)

```


## 7.1.1 If yes to the prior question, specify

```{r fig.height = 3.5}
yao %>%
  filter(mcat_symp != "No symptoms" & !is.na(mcat_symp) & mcat_symp != "") %>%
  filter(mcat_sequela != "") %>%
  plot_upset(mcat_sequela)

```

\newpage

# 8 COVID-19 tests carried out before the visit


## 8.1 Have you carried out any screening test for COVID-19?

```{r}
yao %>%
  countplotprint(has_tested, na_relevel = T, flip = T)
```



## 8.1.1 If you have previously had a COVID test, specify

```{r fig.height = 3.5 }


dict_in <-  read_excel(here("data/EPICO19_-_all_versions_26 11 approved.xlsx"), sheet = 5)

from <- dict_in$from

to <- dict_in$to

dict <- setNames(object = to, nm = from)


# naso test 1
naso1 <- 
  yao %>% 
  filter(!is.na(dt_old_naso1)) %>%
  group_by(cat_old_naso1_result) %>% 
  count(dt_old_naso1) %>% 
  ungroup() %>% 
  uncount(n) %>% 
  mutate(type = "naso") %>% 
  rename(result = 1,
         date =2)

naso2 <- 
  yao %>% 
  filter(!is.na(dt_old_naso2)) %>%
  group_by(cat_old_naso2_result) %>% 
  count(dt_old_naso2) %>% 
  ungroup() %>% 
  uncount(n) %>% 
  mutate(type = "naso") %>% 
  rename(result = 1,
         date =2)

sero1 <- 
  yao %>% 
  filter(!is.na(dt_old_sero1)) %>%
  group_by(cat_old_sero1_result) %>% 
  count(dt_old_sero1) %>% 
  ungroup() %>% 
  uncount(n) %>% 
  mutate(type = "sero") %>% 
  rename(result = 1,
         date =2)


sero2 <- 
  yao %>% 
  filter(!is.na(dt_old_sero2)) %>%
  group_by(cat_old_sero2_result) %>% 
  count(dt_old_sero2) %>% 
  ungroup() %>% 
  uncount(n) %>% 
  mutate(type = "sero") %>% 
  rename(result = 1,
         date =2) %>% 
  mutate(date = as.character(date))


old_tests <- 
  naso1 %>% 
  bind_rows(naso2) %>% 
  bind_rows(sero1) %>% 
  bind_rows(sero2) %>% 
  mutate(date = str_replace_all(date, dict), 
         date = str_replace_all(date, "[:punct:]", "-"), 
         date = as.Date(date)) %>% 
  mutate(result = case_when(result == "positif" ~ "positive", 
                            result == "negatif" ~ "negative", 
                            str_detect(result, "resultat") ~ "unknown"
                            ))
    
unknown_test_count <- 
  old_tests %>% 
  filter(result != "positive") %>% 
  .$date %>% 
  length()
 
old_tests %>% 
  filter(result == "positive") %>% 
  mutate(counter = 1:nrow(.)) %>% 
  ggplot() +
  geom_bar(aes(x = date, fill = type, group = counter), 
           position = "stack", width = 2, color = "white") + 
  scale_fill_manual(values = c("#1c6db0", "coral2")) + 
  scale_y_continuous(breaks = c(0, 2,4,6,8,10)) +
  labs(x = "Date of Test", y = "Count", title = "Count over time of positive COVID-19 tests prior to survey", legend = "Test type")

```

No negative tests were reported, and `r unknown_test_count` tests were reported which had unknown results.

## 8.1.2 If you have previously had a COVID test, for what reason was the test done?

```{r fig.height=3.5, fig.width= 7}
yao %>%
  filter(mcat_test_reason != "") %>%
  plot_upset(mcat_test_reason)

```

## 8.1.1.1 If you responded "Other" to the previous question, specify

```{r}
yao %>% 
  filter(!is.na(cat_test_reason_other)) %>% 
  count(cat_test_reason_other) %>% 
  arrange(-n) %>% 
  rename(`Reasons for testing` = cat_test_reason_other) %>% 
  huxtable() %>% 
  set_all_padding(1.5) %>%
  theme_blue()

```


\newpage

# 9 Comorbidities, risk factors 

## 9.1 What is your height (in cm)?

```{r}

min_height <- min(yao$val_height_cm, na.rm = T)
max_height <- max(yao$val_height_cm, na.rm = T)


yao %>% 
  mutate(val_height_cm= as.numeric(val_height_cm)) %>%
  mutate(val_height_cm = cut(val_height_cm, breaks = seq(from = min_height, to = max_height, by = 25))) %>%
  countplotprint(val_height_cm, remove_titles = F)

```


## 9.2 What is your weight (in kg)?

```{r}

min_weight <- min(yao$val_weight_kg, na.rm = T)
max_weight <- max(yao$val_weight_kg, na.rm = T)


yao %>% 
  mutate(val_weight_kg= as.numeric(val_weight_kg)) %>%
  mutate(val_weight_kg = cut(val_weight_kg, breaks = seq(from = min_weight, to = max_weight, by = 25))) %>%
  countplotprint(val_weight_kg, remove_titles = F)

```


## 9.3 Are you currently a smoker?

```{r}
yao %>% 
  countplotprint(is_smoker, flip = T, fct_reorder = T)
```



## 9.4 Do you suffer from any chronic health problems?

```{r}
yao %>% 
  countplotprint(has_chronic, flip = T, fct_reorder = T, na_relevel = T)
```


## 9.4.1 If you suffer from any health issues / chronic diseases, specify

(Only those who indicated health issues are shown. Thus, the denominator of the percentages is those with indicated issues.)

```{r fig.width=7, fig.height=4}
yao %>% 
  filter(!is.na(mcat_chronic) & mcat_chronic != "") %>%
  plot_upset(mcat_chronic, intersect_cutoff = 0)
```

\newpage

## 9.4.1.1 If you have answered "Other" to the previous question, specify

```{r}

yao %>% 
  filter(!is.na(cat_chronic_other)) %>%
  count(cat_chronic_other) %>%
  separate_rows(cat_chronic_other, sep = ",") %>% 
  mutate(cat_chronic_other = str_replace_all(cat_chronic_other, "-", " "), 
         cat_chronic_other = str_trim(cat_chronic_other),
         cat_chronic_other = str_to_title(cat_chronic_other), 
         cat_chronic_other = stri_trans_general(cat_chronic_other, "Latin-ASCII")
         ) %>% 
  uncount(n) %>% 
  count(cat_chronic_other) %>% 
  arrange(-n) %>% 
  huxtable() %>% 
  set_all_padding(0.5) %>%
  theme_blue()

```


## 9.5 Are you pregnant?

```{r}

yao %>% 
  countplotprint(is_pregnant, na_relevel = T, flip = T)

```

## 9.6 Do you take medications regularly?

```{r}
yao %>% 
  countplotprint(is_medicated, flip = T, na_relevel = T)
```

\newpage

## 9.7 If you take medications regularly, which?

```{r}
drug_table <-
  yao %>%
  filter(!is.na(cat_medication) | cat_medication == "") %>%
  count(cat_medication) %>%
  mutate(
    cat_medication = str_replace_all(cat_medication, "-", " "),
    cat_medication = str_trim(cat_medication),
    cat_medication = str_to_title(cat_medication),
    cat_medication = stri_trans_general(cat_medication, "Latin-ASCII")
  ) %>%
  uncount(n) %>%
  count(cat_medication) %>%
  arrange(-n)


tab_length <- nrow(drug_table)
half_tab_length <- (nrow(drug_table)/2) %>% ceiling()

drug_table1 <- 
  drug_table[1 : half_tab_length ,      ] 
  
drug_table2 <- 
  drug_table[ (half_tab_length + 1) : tab_length, ] %>% 
  rename(`Drug ` = cat_medication , `n ` = n ) 

rows_to_add1 <- nrow(drug_table2) - nrow(drug_table1)
rows_to_add2 <- nrow(drug_table1) - nrow(drug_table2)


if (rows_to_add1 > 0){
  drug_table1 <- 
    drug_table1 %>% 
    add_row(Drug = rep(NA_character_, rows_to_add1), 
            n = rep(NA_integer_, rows_to_add1))
}

if (rows_to_add2 > 0){
  drug_table2 <- 
    drug_table2 %>% 
    add_row(`Drug ` = rep(NA_character_, rows_to_add2), 
            `n ` = rep(NA_integer_, rows_to_add2))
}
  
drug_table1 %>% 
  add_column(drug_table2) %>% 
  huxtable() %>% 
  set_all_padding(0.5) %>%
  theme_blue()
    
```


## 9.8 Have you been in contact with someone who had confirmed or suspected COVID?

```{r}

yao %>% 
  countplotprint(has_contact_COVID, flip = T)

```


## 9.9 Have you been in contact with someone coming from abroad?

```{r}

yao %>% 
  countplotprint(has_contact_traveller, flip = T)

```


## 9.10 Do you think that your risk of getting infected with the new virus is...?

```{r}
yao %>% 
  countplotprint(rate_virus_serious, flip = T)

```

\newpage





