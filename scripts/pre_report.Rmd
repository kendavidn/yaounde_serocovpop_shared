---
title: "Numbers and figures requested for Prelim report"
date: "`r Sys.Date()`"

## Options for outputting HTML

# output:
#   rmarkdown::html_document:
#     theme: cerulean
#     toc: true
#     toc_depth: 2
#     toc_float: true
# 


# # Options for outputting PDF
# output:
#   bookdown::pdf_document2:
#     fig_caption: yes
#     toc: true
#     number_sections: true
#     latex_engine: xelatex
#     includes:
#       in_header: preamble.tex
# mainfont: Avenir
# fontsize: 10pt
# geometry: left=2cm,right=2cm,top=2.5cm,bottom=2cm


# Options for outputting Word
output: word_document
fontsize: 10pt


## Other options
# editor_options: 
#   chunk_output_type: console
# params: 
#   mode: "word"
---

\newpage

```{r readData, echo = FALSE, warning = F, message = F}
library(here)
source(here("scripts/load.R"))
```

```{r utilityFunctions}
source(here("scripts/utils.R"))
```

# Specific numbers requested

```{r}
# begin date for survey
min_dt_quest <- 
  yao$dt_quest %>% 
  min(na.rm = T) %>% 
  format.Date(format = "%d %B")

# end date for survey
max_dt_quest <- 
  yao$dt_quest %>% 
  max(na.rm = T) %>% 
  format.Date(format = "%d %B, %Y")
  
# n of households
n_hhlds_included <- 
  yao$id_hhld %>% 
    unique() %>% 
    length()

# n of individuals    
n_ind_included <- 
  yao$id_ind %>% 
    unique() %>% 
    length()

# mean adults per hhld
mean_n_adults_per_hhld <- 
  yao_hhld$n_hhld_adults %>% 
  mean() %>% 
  round(1)
  
# mean children per hhld
mean_n_children_per_hhld <- 
  yao_hhld$n_hhld_children %>% 
  mean() %>% 
  round(1)

# number of households without a head
n_hhlds_w_o_head <- 
  yao %>% 
  group_by(id_hhld) %>% 
  transmute(is_head = ifelse(is_head == "Yes", 1, 0)) %>% 
  mutate(head_sum = sum(is_head)) %>% 
  slice(1) %>% 
  ungroup() %>% 
  filter(head_sum == 0) %>% 
  nrow()

# percentage of households without a head
pct_hhlds_w_o_head <- 
  (100 * n_hhlds_w_o_head/n_hhlds_included) %>% 
  round(1)

  
# number of households where we could access breadwinner
n_hhlds_w_breadwin <- 
  yao %>% 
  group_by(id_hhld) %>% 
  transmute(is_breadwin = ifelse(is_breadwin == "Yes", 1, 0)) %>% 
  mutate(is_breadwin = sum(is_breadwin)) %>% 
  slice(1) %>% 
  ungroup() %>% 
  filter(is_breadwin > 0) %>% 
  nrow()

# percentage of households where we could access breadwinner
pct_hhlds_w_breadwin <- 
  (100 * n_hhlds_w_breadwin/n_hhlds_included) %>% 
  round(1)

# percentage of hhlds in which the father is breadwinner
pct_hhlds_w_father_breadwin <- 
  (((yao_hhld %>% 
  filter(is_breadwin_father == 1) %>% 
  nrow())/n_hhlds_included)* 100) %>% 
  round(1)
  
# percentage of hhlds in which the mother is breadwinner
pct_hhlds_w_mother_breadwin <- 
  (((yao_hhld %>% 
  filter(is_breadwin_mother == 1) %>% 
  nrow())/n_hhlds_included)* 100) %>% 
  round(1)

# top 4 occupations
top_four_occupations <- 
  yao %>% 
  select(mcat_occup) %>% 
  separate_rows(sep = "--") %>% 
  count(mcat_occup) %>% 
  arrange(-n) %>% 
  head(4) %>% 
  pull(mcat_occup) %>% 
  paste(., collapse = ", ")
 

# pct with death during pandemic
pct_with_death <- 
  (yao_hhld %>% 
  filter(has_hhld_death == "Yes") %>% 
  nrow()*100/n_hhlds_included) %>% 
  round(1)
  
# mean age of death during pandemic
mean_age_death <- 
  yao_hhld %>%  
  filter(!is.na(val_dead1_age)) %>% 
  .$val_dead1_age %>% 
  mean()

# number with positive test
n_hhlds_with_pos_test <- 
  yao_hhld %>%
  filter(has_mem_tested_positive == "Yes") %>% 
  nrow()

# Number with any COVID-like symptoms
n_inds_with_symptoms <- 
  yao %>% 
  filter(mcat_symp != "No symptoms") %>% 
  nrow()

# Percentage with any COVID-like symptoms
pct_inds_with_symptoms <- 
  ((100 * n_inds_with_symptoms)/nrow(yao)) %>% 
  round(1)
  
# percentage complete or partial compliance with preventive measures
pct_respecting_distancing <- 
  ((yao %>% 
  filter(is_respecting_distancing == "Definitely Yes" | is_respecting_distancing == "Partly"  ) %>% 
  nrow() * 100)/nrow(yao)) %>% 
  round(1)

# Number seropositive
n_seropositive <- 
  yao %>% 
  filter(cat_igg_result == "Positive" | cat_igm_result == "Positive" ) %>% 
  nrow()

# Number seropositive
n_seronegative <- 
  yao %>% 
  filter(cat_igg_result == "Negative" & cat_igm_result == "Negative" ) %>% 
  nrow()

```

-   Date of first survey: `r min_dt_quest`

-   Date of last survey: `r max_dt_quest`

-   Number of households surveyed: `r n_hhlds_included`

-   Number of individuals surveyed: `r n_ind_included`

-   Mean number of adults per household: `r mean_n_adults_per_hhld`

-   Mean number of children per household: `r mean_n_children_per_hhld`

-   Number of household where the head was not interviewed: `r n_hhlds_w_o_head`

-   Percentage of household where the head was not interviewed: `r pct_hhlds_w_o_head`%

-   Number of households where the breadwinner was interviewed: `r n_hhlds_w_breadwin`

-   Percentage of households where the breadwinner was interviewed: `r pct_hhlds_w_breadwin`%

-   Percentage of households in which the father is the breadwinner: `r pct_hhlds_w_father_breadwin`%

-   Percentage of households in which the mother is the breadwinner: `r pct_hhlds_w_mother_breadwin`%

-   Top four occupations: `r top_four_occupations`

-   Percentage of households where there has been a death since March 1st: `r pct_with_death`

-   Mean age of those who diead since March 1st: `r mean_age_death`

-   Number of households where a prior positive test was reported: `r n_hhlds_with_pos_test`

-   Number of individuals who have reported any COVID-like symptoms: `r n_inds_with_symptoms`

-   Percentage of individuals who have reported any COVID-like symptoms: `r pct_inds_with_symptoms`

-   Percentage of individuals who are completely or partially complying with social distancing: `r pct_respecting_distancing`%

-   Number seropositive (either IgG or IgM): `r n_seropositive`

-   Number seronegative (both IgG and IgM): `r n_seronegative`



\newpage




# Respondent characteristics

## Sociodemographic characteristics of the final sample


```{r}

sex_count <- 
  yao %>% 
  # summarise
  group_by(cat_sex) %>% 
  count(id_ind) %>% 
  count(n) %>% 
  ungroup() %>% 
  mutate(pct = 100*nn/sum(nn),
         pct = round(pct, 1),
         nn_pct = paste0(nn, " (", pct, "%)")) %>% 
  # add total
  add_row(cat_sex = "Total", 
          nn = sum(.$nn),
          nn_pct = as.character(sum(.$nn)) ) %>% 
  # transform
  select(Sex = cat_sex,
         #nn_pct ,
         nn) %>% 
  mutate(Characteristic = "n") %>% 
  pivot_wider(id_cols = Characteristic, values_from = nn, names_from = Sex) %>% 
  mutate(across(.fns = as.character))


  
hhld_head_m_f <- 
  yao %>% 
  # summarise
  group_by(cat_sex) %>% 
  summarise(n = sum(is_head == "Yes")) %>% 
  ungroup() %>% 
  # add total 
  add_row(cat_sex = "Total",
          n = sum(.$n)) %>% 
  # transform
  #mutate(Characteristic = "Household heads, n (%)") %>% 
  mutate(Characteristic = "Num. household heads") %>% 
  rename(Sex = cat_sex) %>% 
  pivot_wider(id_cols = Characteristic, values_from = n, names_from = Sex) %>% 
  mutate(across(.fns = as.character))
  

mean_age <- 
  yao %>% 
  # summarise
  group_by(cat_sex) %>% 
  summarise(mean_age = format(mean(val_age), digits = 3 ) , 
            sd = format(sd(val_age), digits = 3), 
            mean_sd = paste0(mean_age, " (", sd, ")")
            ) %>% 
  ungroup() %>% 
  # add total
  add_row(cat_sex = "Total",
          mean_age = format(mean(yao$val_age), digits = 3 ), 
          sd = format(sd(yao$val_age), digits = 3)) %>% 
  mutate(mean_sd = ifelse(cat_sex == "Total", 
                          paste0(mean_age, " (", sd, ")"),
                          mean_sd)) %>% 
  # transform
  mutate(Characteristic = "Mean Age (SD)") %>% 
  pivot_wider(id_cols = Characteristic, values_from = mean_sd, names_from = cat_sex)


BMI_row <- 
  yao %>% 
  # summarise
  group_by(cat_sex) %>% 
  summarise(mean_BMI = format(mean(val_BMI), digits = 3 ) , 
            sd = format(sd(val_BMI), digits = 3), 
            mean_sd = paste0(mean_BMI, " (", sd, ")")
            ) %>% 
  ungroup() %>% 
  # add total
  add_row(cat_sex = "Total",
          mean_BMI = format(mean(yao$val_BMI), digits = 3 ), 
          sd = format(sd(yao$val_BMI), digits = 3)) %>% 
  mutate(mean_sd = ifelse(cat_sex == "Total", 
                          paste0(mean_BMI, " (", sd, ")"),
                          mean_sd)) %>% 
  # transform
  mutate(Characteristic = "Mean BMI (SD)") %>% 
  pivot_wider(id_cols = Characteristic, values_from = mean_sd, names_from = cat_sex)


tabulate_categories <- function(df, col) {
  df %>%
    # count
    group_by(cat_sex, {{ col }}) %>%
    count(id_ind) %>%
    count(n) %>%
    ungroup() %>%
    # add percentages
    group_by(cat_sex) %>%
    mutate(
      pct = 100 * nn / sum(nn),
      pct = round(pct, 1)
    ) %>%
    ungroup() %>%
    # add total
    add_row(cat_sex = "Total") %>%
    complete(cat_sex, {{ col }}) %>%
    group_by({{ col }}) %>%
    mutate(nn = ifelse(cat_sex == "Total",
                       sum(nn, na.rm = T), nn)) %>%
    group_by(cat_sex) %>%
    mutate(pct = ifelse(cat_sex == "Total",
                        round(100 * nn / sum(nn, na.rm = T), 1),
                        pct)) %>%
    filter(!is.na({{ col }})) %>%
    {
      suppressWarnings(mutate(., across(.fns = ~ replace_na(.x, 0))))
    } %>%
    # paste count and percentages
    mutate(nn = format(nn, digits = 3)) %>%
    mutate(nn_pct = paste0(nn, " (", pct, "%)")) %>%
    # transform
    select(Characteristic = {{ col }},
           Sex = cat_sex,
           nn_pct) %>%
    pivot_wider(id_cols = Characteristic, values_from = nn_pct, names_from = Sex) %>%
    mutate(across(.fns = as.character))
}


age_groups <- 
  yao %>% 
  # count
  tabulate_categories(cat_age)


education_levels <- 
  yao %>% 
  mutate(cat_educ = recode(cat_educ, "No response" = "Other")) %>% 
  mutate(cat_educ = fct_infreq(cat_educ), 
         cat_educ = fct_relevel(cat_educ, "Other", after = Inf)) %>% 
  tabulate_categories(cat_educ)


professions <- 
  yao %>% 
  # separate
  select(cat_sex, id_ind, mcat_occup) %>% 
  separate_rows(mcat_occup, sep = "--") %>% 
  mutate(mcat_occup = recode(mcat_occup, "No response" = "Other")) %>% 
  mutate(mcat_occup = fct_infreq(mcat_occup)) %>% 
  tabulate_categories(mcat_occup)


chronic_illnesses <- 
  yao %>% 
  # separate
  select(cat_sex, id_ind, mcat_chronic) %>% 
  separate_rows(mcat_chronic, sep = "--") %>% 
  mutate(mcat_chronic = recode(mcat_chronic, "Other chronic illness" = "Other")) %>% 
  mutate(mcat_chronic = fct_infreq(mcat_chronic), 
          mcat_chronic = fct_relevel(mcat_chronic, "Other", after = Inf)) %>% 
  # count
  tabulate_categories(mcat_chronic)


sample_table <- 
  sex_count %>% 
  bind_rows(hhld_head_m_f) %>% 
  bind_rows(mean_age) %>% 
  bind_rows(BMI_row) %>% 
  add_row(Characteristic  = "Age groups, n (% of sex in each group)") %>% 
  bind_rows(age_groups) %>% 
  add_row(Characteristic  = "Education Level, n (% of sex in each group)") %>% 
  bind_rows(education_levels) %>% 
  add_row(Characteristic  = "Profession, n (% of sex in each group)") %>% 
  bind_rows(professions) %>% 
  add_row(Characteristic  = "Chronic conditions, n (% of sex with that condition)") %>% 
  bind_rows(chronic_illnesses) %T>% 
  {which(is.na(.$Female)) ->> rows_to_merge } %>% 
  huxtable() %>% 
  theme_basic() %>% 
  merge_across(row = rows_to_merge + 1) %>% 
  set_italic(row = c(rows_to_merge + 1), col = 1) %>% 
  set_latex_float("h!") %>% 
  set_all_padding(0.5)

sample_table

```

\newpage


# Seroprevalence estimates

## Seropositivity of respondents by test type (Euler diagram)

```{r fig.width = 4, fig.height = 3}


source(here("scripts/seropos_euler.R"))
seropos_euler_plot

```


## Seropositivity in each age-sex stratum. 

Positive cases include only individuals positive for IgG antibodies 

```{r fig.width = 6, fig.height = 4}

source(here("scripts/pos_age_sex_pyramid.R"))

pos_age_sex_pyramid


```


## Population-weighted and test-adjusted seroprevalence estimates 

```{r}
source(here("scripts/sero_estim.R"))

igg_pos_table_print

igm_pos_table_print


```

## Seropositivity map

Geographic variation in seroprevalence levels. 

Fill color indicates overall prevalence (IgG or IgM) in each region. 
Pie charts indicate household size, household location and proportion of the household that is seropositive (either IgG or IgM). 
Pie charts are dodged in extra-dense regions to avoid overlap.

We can see that the region with the smallest households, Cité Verte, also had the lowest overall prevalence. 

```{r fig.width = 7.4, fig.height = 7.8}

source(here("scripts/map.R"))

scatterpie_map
```
* 5 households had either missing or improperly coded coordinates and are not shown on the map.



## Risk factors for seropositivity

(Only regressors where the p-value for at least one factor level was below 0.1 are shown.)

```{r fig.width = 7.5, fig.height = 7.5}
source(here("scripts/infection_regn.R"))

infection_regn_plot
```

Based on `r sample_for_infection_regn` individuals.  `r nrow(yao) - sample_for_infection_regn` were dropped due to variable missingness.


# COVID-19 related Symptoms

## Symptoms among study population

Denominator is all respondents
```{r fig.width=7, fig.height= 3.6}

# theme
my_theme <- theme_classic() +
  theme(text = element_text( size = 12.5, family = "Avenir Next"),
        rect = element_blank(), # transparent background
        plot.title = (element_text(face = "bold", hjust = 0.5, size = 13)),
        plot.subtitle = (element_text( hjust = 0.5, size = 8, color = alpha("black", 0.7))),
        plot.caption = element_text(size = 6.5, color = "gray50", hjust = 1),
        legend.position = "bottom",
        legend.text = element_text(size = 8),
        legend.key.size = unit(1,"line"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9 ),
        axis.line = element_line(color = "gray40", size = 0.5),
        axis.line.y = element_blank(),
        panel.grid.major = element_line(color = alpha("gray50", 0.1), size = 0.25), 
        strip.background = element_blank(),
        strip.text = element_text(face = "bold", color = 'white'),
        panel.spacing.x = unit(3, "mm"), 
        title = element_text(face = "bold"), 
        panel.border = element_blank(),
        plot.background = element_rect(fill = "transparent"), 
        panel.background = element_rect(fill = "transparent")
        #strip.background = element_blank()
  )

theme_set(my_theme)


yao %>%
  filter(mcat_symp != "No symptoms") %>%
  plot_upset(mcat_symp,
             intersect_cutoff = 3,
             denom = yao,
             sep = "--",
             set_size_lab = "Prevalence \n(n and % with this symptom)",
             intersect_size_lab = "Co-prevalence \n (n and % with this combination of symptoms)"
             )


```



## Common symptoms in seropositive and seronegative individuals

```{r fig.width=3.5, fig.height=5}
source(here("scripts/symptoms_per_sero_cat_plot.R"))

symptoms_per_sero_cat_plot
```


## Have you taken one or several medications for symptoms characteristic of COVID-19?

(Denominator of percentages is those who reported any acute symptom compatible with COVID-19)

```{r fig.width=7, fig.height= 3.6}

yao_symptoms <- 
  yao %>% 
  filter(mcat_symp != "No symptoms")


yao %>%
  filter(mcat_symp != "No symptoms") %>%
  filter(mcat_drug != "No response") %>%
  filter(!is.na(mcat_drug)) %>% 
  plot_upset(cat_col = mcat_drug,
             intersect_cutoff = 2,
             denom = yao_symptoms,
             sep = "--"
             )

```


## Risk factors for symptomatic COVID-19

COVID-19 symptoms are defined as: 

•	anosmia OR ageusia; or
•	cough AND fever; or 
•	at least THREE of cough, fever, fatigue, headache, muscle pain, sore throat, runny/stuffy nose, shortness of breath, nausea, diarrhoea. 


```{r}
yao %>% 
  group_by(cat_pos, has_COVID_symptoms) %>% 
  count() %>% 
  ungroup() %>% 
  pivot_wider(id_cols = cat_pos, names_from = has_COVID_symptoms, values_from = n) %>% 
  mutate(pct = round(100*Yes/(Yes+No), 2) ) %>% 
  mutate(cat_pos = as.character(cat_pos), 
         cat_pos = replace_na(cat_pos, "No test")) %>% 
  rename(`IgG Seropositivity` = cat_pos, 
         `Has COVID symptoms` = Yes, 
         `No COVID symptoms` = No, 
         `Percent with Symptoms` = pct
         ) %>% 
  huxtable() %>% 
  theme_basic() %>% 
  set_latex_float("h!") %>% 
  set_all_padding(0.5)
```



(Only regressors where the p-value for at least one factor level was below 0.1 are shown.)
```{r fig.width=7.5, fig.height=3.3}
source(here("scripts/symp_regn.R"))

symptomatic_regn_plot 

```

Based on `r sample_for_symp_regn` individuals.  `r nrow(yao) - sample_for_symp_regn` were dropped due to variable missingness.



# Health-seeking behavior

## Symptoms Euler diagram

```{r fig.width = 5, fig.height = 2.8}
healthcare_needing_pop <-  
  yao_has_chron_or_symp %>% 
  summarise(
    with_acute_symptoms_alone = sum(mcat_symp != "No symptoms" & has_chronic == "No comorbidity"), 
    with_comorbid_alone = sum(has_chronic == "Has comorbidity" & mcat_symp == "No symptoms" ), 
    either = n(), 
    both = sum(mcat_symp != "No symptoms" & has_chronic == "Has comorbidity"), 
    everyone = nrow(yao)
    )
   

symptoms_df <-  
  yao %>% 
  summarise(
    chronic_alone = sum(has_acute_symp == "No" &  has_COVID_symptoms == "No" & has_chronic == "Has comorbidity"),
    acute_alone = sum(has_acute_symp == "Yes" & has_COVID_symptoms == "No" & has_chronic == "No comorbidity"), 
    COVIDlike_alone = 0, # all those with COVID-suspect symptoms must be subset of acute symptoms group
    chronic_and_acute = sum(has_acute_symp == "Yes" &  has_COVID_symptoms == "No" & has_chronic == "Has comorbidity"),
    chronic_and_COVIDlike = 0, # all those with COVID-suspect and comorbidites must also be subset of acute sypmtoms group
    acute_and_COVIDlike = sum(has_acute_symp == "Yes" &  has_COVID_symptoms == "Yes" & has_chronic == "No comorbidity"),
    chronic_and_acute_and_COVIDlike = sum(has_acute_symp == "Yes" &  has_COVID_symptoms == "Yes" & has_chronic == "Has comorbidity"),
    everyone = nrow(yao)) %>% 
  rowwise() %>% 
  mutate(any_symp_or_condition = rowSums(.[1:7]))

set.seed(4)
intersecting_inside <- 
  euler(c(
    # technically the "No symptoms of condition" set should be called the "everyone" set. But leaving it this way makes the final venn diagram easier to interpret
    "No symptoms or condition" = symptoms_df$everyone - symptoms_df$any_symp_or_condition, # all respondents alone
   # "With chronic condition(s)" = 0, # Impossible (not part of everyone set)
  #  "With acute symptom(s)" = 0,  # Impossible (not part of everyone set)
  #  "With COVID-suspect symptom(s)" = 0,  # Impossible (not part of everyone set),
    "No symptoms or condition&Chronic condition(s)" = symptoms_df$chronic_alone,
    "No symptoms or condition&Acute symptom(s)" = symptoms_df$acute_alone,
   # "No symptoms or condition&With COVID-suspect symptom(s)" = 0, # impossible (not part of acute symptoms set)
    "No symptoms or condition&Chronic condition(s)&Acute symptom(s)" = symptoms_df$chronic_and_acute,
    "No symptoms or condition&Chronic condition(s)&COVID-suspect acute symptom(s)" = 0, # impossible (not part of acute symptoms set)
    "No symptoms or condition&Acute symptom(s)&COVID-suspect acute symptom(s)" = symptoms_df$acute_and_COVIDlike, 
    "No symptoms or condition&Chronic condition(s)&Acute symptom(s)&COVID-suspect acute symptom(s)" = symptoms_df$chronic_and_acute_and_COVIDlike))


set.seed(4)
plot(intersecting_inside,
     fills = list(fill = c(alpha(my_lightgreen, 0.4),
                           alpha("darkgoldenrod1", 0.7),
                           alpha("firebrick1", 0.3),
                           alpha("tomato2", 0.8)
                           )),
     legend = list(side = "right",
                   fontsize = 9), 
     quantities = list(type = "counts",
                       family = "Avenir Next", 
                        fontsize = 10), 
     edges = list(col = "transparent", 
                   family = "Avenir Next"))


   
# 
# set.seed(2)
# intersecting_inside <- euler(c("No symptom or condition" = healthcare_needing_pop$everyone - healthcare_needing_pop$either, 
#                                "Chronic condition" = 0, # Chronic condition alone (not part of everyone set)
#                                "Acute symptom" = 0,  # Acute condition alone (not part of everyone set)
#                                "No symptom or condition&Chronic condition" = healthcare_needing_pop$with_comorbid_alone, 
#                                "No symptom or condition&Acute symptom"  = healthcare_needing_pop$with_acute_symptoms_alone, 
#                                "Chronic condition&Acute symptom" = 0,   # Acute condition & Chronic cond alone (not part of everyone set)
#                                "No symptom or condition&Chronic condition&Acute symptom" = healthcare_needing_pop$both))
# 
# 

```


## Where did you consult for symptoms? (Among those who reported any acute symptom or chronic condition)

This is a combination of question 6.1.1, on COVID-related consultations, and question 11.7, on non-COVID-related consultations.
```{r fig.width=7, fig.height=4}

yao_has_chron_or_symp <-  
  yao_has_chron_or_symp %>% 
  mutate(mcat_consult_any = replace_na(mcat_consult_any, replace = "No response"))


yao_has_chron_or_symp %>% 
  filter(mcat_consult_any != "No response") %>% 
  plot_upset(cat_col = mcat_consult_any,
             denom = yao_has_chron_or_symp,
             sep = "--",
             set_size_lab = "Set size, \n % who consulted here", 
             intersect_size_lab = "Intersection size, \n % who consulted with this combination",
             intersect_cutoff = 1)

```


## Barriers to care among the health-care needing population (symptom or chronic condition)

```{r, fig.width=5.7, fig.height=3.3}
source(here("scripts/barriers_to_healthcare.R"))

barriers_to_healthcare_plot
```


## Have you taken one or several medications for symptoms characteristic of COVID-19? (Question 6.2)

(Among those who reported COVID-suspect symptoms)

```{r fig.width=7, fig.height=5}
yao_has_COVID_symptoms <- 
  yao %>% 
  filter(has_COVID_symptoms == "Yes")

yao_has_COVID_symptoms %>%
  filter(mcat_drug != "No response") %>%
  filter(!is.na(mcat_drug)) %>% 
  plot_upset(cat_col = mcat_drug,
             intersect_cutoff = 2,
             denom = yao_has_COVID_symptoms,
             sep = "--"
             )

```



## Regression on use of formal health services by those reporting COVID-19 suspect symptoms

```{r, fig.width=7.5, fig.height=4}
source(here("scripts/sought_healthcare_regn.R"))

consulted_care_regn_plot
```


# Attitudes towards the pandemic

## Respect of distancing measures

```{r fig.width=3.7, fig.height=7.1}
source(here("scripts/follow_distancing_rules.R"))
follow_distancing_rules_plot
```


## Other attitudes

```{r fig.width=6.2, fig.height=3.3}
source(here("scripts/attitudes_to_COVID.R"))

attitudes_to_COVID_plot

```


# Impact on households

## 3.5 Since March 1st, has the revenue of the household diminished?

(results only shown for the answers from household representatives)

```{r fig.width=3.2, fig.height=7.8}
source(here("scripts/has_rev_dropped.R"))

has_rev_dropped_plot
```


## 14.1 Unable to carry out daily activities (other than work), such as visiting family, making meals, taking care of the children.

```{r fig.width=3.2, fig.height=7.8}
source(here("scripts/has_confin_disrupted_life.R"))

has_confin_disrupted_life_plot
```


## 14.2 Have you stopped working or stopped one of your jobs due to the confinement?
```{r fig.width=3.2, fig.height=7.8}
source(here("scripts/has_confin_stopped_work.R"))

has_confin_stopped_work_plot
```


## 14.4 Within your household, have you faced any physical or psychological violence since March 1st?
```{r fig.width=3.2, fig.height=7.8}
source(here("scripts/has_faced_violence.R"))

has_faced_violence_plot
```


<!-- ## Fear of stigma and the use of formal health services. -->

<!-- ```{r} -->
<!-- yao_has_chron_or_symp %>%  -->
<!--   group_by(has_consult_formal_care, is_fearful_stigma) %>%  -->
<!--   count() %>%  -->
<!--   arrange(is_fearful_stigma) -->

<!-- ``` -->



<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->
<!-- Divider divider you are here -->







<!-- ## Seropositivity breakdown table 1 -->

<!-- (see next page) -->

<!-- \newpage -->

<!-- ```{r} -->

<!-- pos_count <-  -->
<!--   yao %>%  -->
<!--   filter(!is.na(cat_pos)) %>%  -->
<!--   # summarise -->
<!--   group_by(cat_pos) %>%  -->
<!--   count(id_ind) %>%  -->
<!--   count(n) %>%  -->
<!--   ungroup() %>%  -->
<!--   # transform -->
<!--   select(pos = cat_pos, -->
<!--          nn) %>%  -->
<!--   mutate(Characteristic = "n") %>%  -->
<!--   pivot_wider(id_cols = Characteristic, values_from = nn, names_from = pos) %>%  -->
<!--   mutate(across(.fns = as.character)) -->


<!-- mean_age <-  -->
<!--   yao %>%  -->
<!--   filter(!is.na(cat_pos)) %>%  -->
<!--   # summarise -->
<!--   group_by(cat_pos) %>%  -->
<!--   summarise(mean_age = format(mean(val_age), digits = 3 ) ,  -->
<!--             sd = format(sd(val_age), digits = 3),  -->
<!--             mean_sd = paste0(mean_age, " (", sd, ")") -->
<!--             ) %>%  -->
<!--   ungroup() %>%  -->
<!--   # transform -->
<!--   mutate(Characteristic = "Mean Age (SD)") %>%  -->
<!--   pivot_wider(id_cols = Characteristic, values_from = mean_sd, names_from = cat_pos) -->


<!-- BMI_row <-  -->
<!--   yao %>%  -->
<!--   filter(!is.na(cat_pos)) %>%  -->
<!--   # summarise -->
<!--   group_by(cat_pos) %>%  -->
<!--   summarise(mean_BMI = format(mean(val_BMI), digits = 3 ) ,  -->
<!--             sd = format(sd(val_BMI), digits = 3),  -->
<!--             mean_sd = paste0(mean_BMI, " (", sd, ")") -->
<!--             ) %>%  -->
<!--   ungroup() %>%  -->
<!--   # transform -->
<!--   mutate(Characteristic = "Mean BMI (SD)") %>%  -->
<!--   pivot_wider(id_cols = Characteristic, values_from = mean_sd, names_from = cat_pos) -->


<!-- tabulate_sero_categories <- function(df, col) { -->
<!--   df %>% -->
<!--     mutate(counter = 1) %>% -->
<!--     group_by(cat_pos) %>% -->
<!--     mutate(n_pos_neg = length(unique(id_ind))) %>% -->
<!--     group_by(cat_pos, {{ col }}) %>% -->
<!--     transmute( -->
<!--       n_pos_neg_per_cat = sum(counter), -->
<!--       n_pos_neg = n_pos_neg -->
<!--     ) %>% -->
<!--     slice(1) %>% -->
<!--     ungroup() %>% -->
<!--     mutate( -->
<!--       pct = 100 * n_pos_neg_per_cat / n_pos_neg, -->
<!--       pct = round(pct, 1) -->
<!--     ) %>% -->
<!--     # paste count and percentages -->
<!--     mutate(n_pos_neg_per_cat = format(n_pos_neg_per_cat, digits = 5)) %>% -->
<!--     mutate(nn_pct = paste0(n_pos_neg_per_cat, " (", pct, "%)")) %>% -->
<!--     # transform -->
<!--     select( -->
<!--       Characteristic = {{ col }}, -->
<!--       pos = cat_pos, -->
<!--       nn_pct -->
<!--     ) %>% -->
<!--     pivot_wider(id_cols = Characteristic, values_from = nn_pct, names_from = pos) %>% -->
<!--     mutate(across(.fns = as.character)) -->
<!-- } -->

<!-- sex_groups <-  -->
<!--   yao %>%  -->
<!--   filter(!is.na(cat_sex) & !is.na(cat_pos)) %>%  -->
<!--   tabulate_sero_categories(cat_sex) -->

<!-- age_groups <-  -->
<!--   yao %>%  -->
<!--   mutate(cat_age = cut(val_age,  -->
<!--                        breaks = c(4.9,15,29,45,65,100),  -->
<!--                        labels = c("5-15", "16-29", "30-45", "46-65", "above 65") -->
<!--                        )) %>% -->
<!--   filter(!is.na(cat_age) & !is.na(cat_pos)) %>%  -->
<!--   tabulate_sero_categories(cat_age) -->


<!-- education_levels <-  -->
<!--   yao %>%  -->
<!--   mutate(cat_educ = recode(cat_educ, "No response" = "Other")) %>%  -->
<!--   mutate(cat_educ = fct_infreq(cat_educ),  -->
<!--          cat_educ = fct_relevel(cat_educ, "Other", after = Inf)) %>%  -->
<!--   filter(!is.na(cat_educ) & !is.na(cat_pos)) %>%  -->
<!--   tabulate_sero_categories(cat_educ) -->


<!-- professions <-  -->
<!--   yao %>%  -->
<!--   # separate -->
<!--   select(cat_pos, id_ind, mcat_occup) %>%  -->
<!--   separate_rows(mcat_occup, sep = "--") %>%  -->
<!--   mutate(mcat_occup = recode(mcat_occup, "No response" = "Other")) %>%  -->
<!--   mutate(mcat_occup = fct_infreq(mcat_occup)) %>%  -->
<!--   filter(!is.na(mcat_occup) & !is.na(cat_pos)) %>%  -->
<!--   tabulate_sero_categories(mcat_occup) -->

<!-- symptoms <-  -->
<!--   yao %>%  -->
<!--   # separate -->
<!--   select(cat_pos, id_ind, mcat_symp) %>%  -->
<!--   separate_rows(mcat_symp, sep = "--") %>%  -->
<!--   mutate(mcat_symp = fct_infreq(mcat_symp)) %>%  -->
<!--   filter(!is.na(mcat_symp) & !is.na(cat_pos)) %>%  -->
<!--   tabulate_sero_categories(mcat_symp) -->


<!-- sero_table <-  -->
<!--   pos_count %>%  -->
<!--   bind_rows(mean_age) %>%  -->
<!--   bind_rows(BMI_row) %>%  -->
<!--   add_row(Characteristic  = "Age groups, n (% of all positive/negatives that are of each sex)") %>%  -->
<!--   bind_rows(sex_groups) %>%  -->
<!--   add_row(Characteristic  = "Age groups, n (% of all positive/negatives that are in each age group)") %>%  -->
<!--   bind_rows(age_groups) %>%  -->
<!--   add_row(Characteristic  = "Education Level, n (% of all positive/negatives that are in each education class)") %>%  -->
<!--   bind_rows(education_levels) %>%  -->
<!--   add_row(Characteristic  = "Profession, n (% of all positive/negatives that are in each profession class)") %>%  -->
<!--   bind_rows(professions) %>%  -->
<!--   add_row(Characteristic  = "Symptoms, n (% of all positive/negatives that reported each symptom)") %>%  -->
<!--   bind_rows(symptoms) %T>%  -->
<!--   {which(is.na(.$Negative)) ->> rows_to_merge } %>%  -->
<!--   huxtable() %>%  -->
<!--   theme_basic() %>%  -->
<!--   merge_across(row = rows_to_merge + 1) %>%  -->
<!--   set_italic(row = c(rows_to_merge + 1), col = 1) %>%  -->
<!--   set_latex_float("h!") %>%  -->
<!--   set_all_padding(0.5) -->

<!-- sero_table -->
<!-- ``` -->


<!-- \newpage -->

<!-- ## Symptoms reported (since March 1st) -->

<!-- All respondents. Denominator of percentages is everyone who was surveyed. -->

<!-- ```{r fig.width = 7, fig.height = 4.1} -->

<!-- yao %>% -->
<!--   plot_upset(mcat_symp, -->
<!--              intersect_cutoff = 3, -->
<!--              set_size_lab = "Prevalence \n(n and % with this symptom)", -->
<!--              intersect_size_lab = "Co-prevalence \n (n and % with this combination of symptoms)") -->

<!-- ``` -->

<!-- Subset of those who have had symptoms. Denominator of percentages is everyone who was surveyed. -->

<!-- ```{r fig.width = 7, fig.height = 4.1} -->

<!-- yao %>% -->
<!--   filter(mcat_symp != "No symptoms") %>% -->
<!--   plot_upset(mcat_symp, -->
<!--              intersect_cutoff = 3, -->
<!--              sep = "--", -->
<!--              set_size_lab = "Prevalence \n(n and % with this symptom)", -->
<!--              intersect_size_lab = "Co-prevalence \n (n and % with this combination of symptoms)" -->
<!--              ) -->

<!-- ``` -->

<!-- Subset of those who had a positive IgG or IgM test and have reported symptoms. Denominator of percentages is everyone who was seropositive. -->

<!-- ```{r fig.width = 7, fig.height = 4.4} -->

<!-- seropos_sub <- yao %>% -->
<!--   filter(cat_igg_result == "Positive" | cat_igm_result == "Positive")  -->

<!-- seropos_sub %>% -->
<!--   filter(mcat_symp!= "No symptoms") %>%  -->
<!--   plot_upset(mcat_symp, -->
<!--              denom = seropos_sub, -->
<!--              intersect_cutoff = 2, -->
<!--              sep = "--", -->
<!--               set_size_lab = "Prevalence \n(n and % with this symptom)", -->
<!--              intersect_size_lab = "Co-prevalence \n (n and % with this combination of symptoms)" -->
<!--              ) -->

<!-- ``` -->

<!-- Subset of those who had negative test results for both the IgG and IgM and have reported symptoms. Denominator of percentages is everyone who was seronegative -->


<!-- ```{r fig.width = 7, fig.height = 4.4} -->

<!-- seroneg_sub <- yao %>% -->
<!--   filter(cat_igg_result == "Negative" & cat_igm_result == "Negative") -->

<!-- seroneg_sub %>% -->
<!--   filter(mcat_symp!= "No symptoms") %>%  -->
<!--   plot_upset(mcat_symp, -->
<!--              denom = seroneg_sub, -->
<!--              intersect_cutoff = 2, -->
<!--              sep = "--", -->
<!--              set_size_lab = "Prevalence \n(n and % with this symptom)", -->
<!--              intersect_size_lab = "Co-prevalence \n (n and % with this combination of symptoms)" -->
<!--              ) -->
<!-- ``` -->



<!-- ## Questions on respect of hygiene behavior -->


<!-- ```{r fig.width=4.5, fig.height=6.1} -->

<!-- hygiene_survey_plot <- list( geom_col(position = "stack", width= 0.75) , -->
<!--   # geom_text(aes(label = countprop), -->
<!--   #           position = "stack", vjust = -1, hjust = 1.5, color = "white", -->
<!--   #           size = 3, fontface = "plain") , -->
<!--   geom_richtext(aes(label = countprop), -->
<!--             position = "stack", vjust = 0.5, hjust = 1.1, size = 3.3, lineheight = 0.85,  -->
<!--             label.size =0, color = "white", show.legend = FALSE,  -->
<!--             label.padding = unit(c(0.1, 0.1, 0.1, 0.1), "lines")) , -->
<!--   coord_flip(clip = "off") , -->
<!--   scale_y_continuous(expand = expansion(add = c(0,0))) , -->
<!--   scale_fill_manual(limits = c("Definitely yes", "Partly", "Definitely not"),  -->
<!--                     values = c( my_green, my_lightgreen, my_orange )) , -->
<!--   theme_minimal() , -->
<!--   theme( -->
<!--         text = element_text(family = "Avenir Next"), -->
<!--         plot.title = element_textbox_simple(face = "bold.italic",  -->
<!--                                      color = "gray20",  -->
<!--                                      family = "Avenir Next", -->
<!--                                      size = 9, -->
<!--                                      hjust = 0, padding = margin(0, 0, 0, 0),  -->
<!--                                      lineheight = 0.5), -->
<!--         plot.subtitle = element_text(face = "italic", color = "gray30", hjust = 0), -->
<!--         axis.text.y = element_text(color = "black", size = 10), -->
<!--         plot.title.position = "plot", -->
<!--         legend.position = "top",  -->
<!--         legend.direction = "horizontal",  -->
<!--         legend.title = element_blank(),  -->
<!--         panel.grid = element_blank(),  -->
<!--         legend.text = element_text(size = 10),  -->
<!--         axis.text.x = element_blank()) ) -->

<!-- basic_hygiene <-  -->
<!-- yao %>% -->
<!--   filter(!is.na(cat_pos) & !is.na(is_respecting_hygiene)) %>% -->
<!--   filter(is_respecting_hygiene != "No response") %>% -->
<!--   # filter(is_respecting_hygiene != "Partly" & is_respecting_hygiene != "No response") %>% -->
<!--   group_by(cat_pos, is_respecting_hygiene) %>% -->
<!--   summarise(n = n()) %>% -->
<!--   group_by(cat_pos) %>% -->
<!--   mutate(pct = 100 * n / sum(n),  -->
<!--          pct_paste = round(pct, 0), -->
<!--          countprop = paste0("<span style='color:white'><i><b>",pct_paste, "%", "</i></b></span>","<br>", "<span style='font-size:7pt'>", -->
<!--                             "n = ",n,"  </span>"),  -->
<!--          countprop = if_else(pct >= 7, countprop, NA_character_)) %>% -->
<!--   mutate(cat_pos = factor(cat_pos,levels = c("Positive", "Negative"))) %>% -->
<!--   mutate(cat_pos = recode(cat_pos, "Positive" = "Seropositive", "Negative" = "Seronegative")) %>% -->
<!--   mutate(is_respecting_hygiene = factor(is_respecting_hygiene,levels = c("Definitely not", "Partly", "Definitely yes"))) %>% -->
<!--   ggplot(aes(x = cat_pos, y = pct, fill = is_respecting_hygiene)) + -->
<!--   labs(title = 'Do you follow the basic hygiene protocols (wash hands frequently, sneeze in your elbow, use a disposable tissue, etc.)', x = "", y = "") + -->
<!--   hygiene_survey_plot -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- # social_distancing <-  -->
<!-- # yao %>% -->
<!-- #   filter(!is.na(cat_pos) & !is.na(is_respecting_distancing)) %>% -->
<!-- #   filter(is_respecting_distancing != "No response") %>% -->
<!-- #   # filter(is_respecting_hygiene != "Partly" & is_respecting_hygiene != "No response") %>% -->
<!-- #   group_by(cat_pos, is_respecting_distancing) %>% -->
<!-- #   summarise(n = n()) %>% -->
<!-- #   group_by(cat_pos) %>% -->
<!-- #  mutate( -->
<!-- #     pct = 100 * n / sum(n), -->
<!-- #     pct_paste = round(pct, 0), -->
<!-- #     countprop = paste0( -->
<!-- #      "<span style='color:white'><i><b>", -->
<!-- #       pct_paste, "%", "</i></b></span>", -->
<!-- #       "<br>",  -->
<!-- #       "<span style='font-size:7pt'>", -->
<!-- #       "n = ", -->
<!-- #       n, -->
<!-- #       "  </span>" -->
<!-- #     ),  -->
<!-- #       countprop = if_else(pct >= 7, countprop, NA_character_) -->
<!-- #   ) %>% -->
<!-- #   mutate(cat_pos = factor(cat_pos, -->
<!-- #     levels = c("Positive", "Negative") -->
<!-- #   )) %>% -->
<!-- #   mutate(cat_pos = recode(cat_pos, "Positive" = "Seropositive", "Negative" = "Seronegative")) %>% -->
<!-- #   mutate(is_respecting_distancing = factor(is_respecting_distancing, -->
<!-- #     levels = c("Definitely not", "Partly", "Definitely yes") -->
<!-- #   )) %>% -->
<!-- #   ggplot(aes(x = cat_pos, y = pct, fill = is_respecting_distancing)) + -->
<!-- #   labs( -->
<!-- #     title = '<br><span style = "font-size:9pt; color:#000000;">*Do you follow social distancing recommendations (avoid handshakes or hugs, avoid unnecessary outings, etc.)* </span>', -->
<!-- #     x = "", y = "" -->
<!-- #   ) + -->
<!-- #   hygiene_survey_plot + -->
<!-- #   theme(legend.position = "none") -->
<!-- #  -->

<!-- confinement <-  -->
<!-- yao %>% -->
<!--   filter(!is.na(cat_pos) & !is.na(is_staying_confined)) %>% -->
<!--   filter(is_staying_confined != "No response") %>% -->
<!--   # filter(is_respecting_hygiene != "Partly" & is_respecting_hygiene != "No response") %>% -->
<!--   group_by(cat_pos, is_staying_confined) %>% -->
<!--   summarise(n = n()) %>% -->
<!--   group_by(cat_pos) %>% -->
<!--   mutate(pct = 100 * n / sum(n), -->
<!--          pct_paste = round(pct, 0), -->
<!--          countprop = paste0("<span style='color:white'><i><b>",pct_paste, "%", "</i></b></span>","<br>", "<span style='font-size:7pt'>", -->
<!--                             "n = ",n,"  </span>"),  -->
<!--          countprop = if_else(pct >= 7, countprop, NA_character_)) %>% -->
<!--   mutate(cat_pos = factor(cat_pos,levels = c("Positive", "Negative"))) %>% -->
<!--   mutate(cat_pos = recode(cat_pos, "Positive" = "Seropositive", "Negative" = "Seronegative")) %>% -->
<!--   mutate(is_staying_confined = factor(is_staying_confined, -->
<!--                                       levels = c("Definitely not", "Partly", "Definitely yes"))) %T>% -->
<!--   {. ->> data_to_plot} %>% -->
<!--   ggplot(aes(x = cat_pos, y = pct, fill = is_staying_confined)) + -->
<!--   labs(title = 'Since March 1st, have you stayed confined?',x = "", y = "") + -->
<!--   hygiene_survey_plot + -->
<!--   theme(legend.position = "none") -->


<!-- line_sep <-  -->
<!--   linesGrob(unit(c(0, 1), "npc"), unit(1, "npc"), -->
<!--                             gp = gpar(col = 'lightgrey', lwd = 4)) %>%  -->
<!--   wrap_elements() -->

<!-- hygiene_measures_plot <- patchwork::wrap_plots(basic_hygiene,  -->
<!--                       line_sep,  -->
<!--                       #social_distancing,  -->
<!--                       #line_sep,  -->
<!--                       confinement,  -->
<!--                       ncol = 1, heights = c(1, -->
<!--                                             0.1, -->
<!--                                             # 1, -->
<!--                                             #0.1, -->
<!--                                             1)) -->
<!-- hygiene_measures_plot -->

<!-- ``` -->

































